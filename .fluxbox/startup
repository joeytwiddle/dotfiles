# fluxbox startup-script:
#
# Lines starting with a '#' are ignored.

# You can set your favourite wallpaper here if you don't want
# to do it from your style.
#
# fbsetbg -f ~/pictures/wallpaper.png
#
# This sets a black background

/usr/bin/fbsetroot -solid black

# This shows the fluxbox-splash-screen
# fbsetbg -C /usr/share/fluxbox/splash.jpg

# Other examples. Check man xset for details.
#
# Turn off beeps:
# xset -b
#
# Increase the keyboard repeat-rate:
# xset r rate 195 35
#
# Your own fonts-dir:
# xset +fp /home/joey/linux/.font
#
# Your favourite mouse cursor:
# xsetroot -cursor_name right_ptr
#
# Change your keymap:
# xmodmap ~/.Xmodmap


#set -x
#exec 1> ~/jsh.log
#exec 2> ~/jsh.error

# You can probably read the fb-startup logs in ~/.xsession-errors

if [ -z "$JPATH" ]
then
	echo "[fb-startup] Loading jsh before starting Fluxbox" >&2
	export JPATH="$HOME/j"
	. "$JPATH"/startj
fi


# Applications you want to run with fluxbox.
# MAKE SURE THAT APPS THAT KEEP RUNNING HAVE AN ''&'' AT THE END.
#
# unclutter -idle 2 &
# wmnd &
# wmsmixer -w &
# idesk &

(

	sleep 1   # Focus on starting fluxbox

	# Start an xterm.  That is what the user (joey) wants.  Other things can run in parallel.
	xterm &

	echo "[fb-startup] Running .joeys_x_essentials" >&2

	#randomwallpaper &
	# I used to source (.) this but:
	# - If it exits, then this script will stop executing and Fluxbox won't start!
	# - We don't need it, because it doesn't export any VARS at the moment.
	bash "$HOME"/.joeys_x_essentials

	echo "[fb-startup] Starting apps" >&2

	sleep 1

	bbkeys &
	gkrellm &

	sleep 1

	lxpanel &
	/opt/trinity/bin/kicker &
	# If we wait a bit longer, the nm-applet will be placed in the lxpanel instead of the Flubbox panel.
	#sleep 2

	nm-applet &

	# Something is starting gnome-screensaver.  I think it might be nm-applet but I'm not sure.
	# I don't want gnome-screensaver if I have xscreensaver running, because I end up having to unlock twice!
	( sleep 20 ; pgrep -u $UID xscreensaver && killall gnome-screensaver ) &
	# Possibly if I started xscreensaver later, or gnome-screensaver explicitly, one would disable the other.  But currently this is not happening.

	sleep 1

	(
		# If I try to do this too early, there is no ibus running to replace!
		sleep 5

		# Note that this should be done before running setxkbmap, because it resets it!
		if pgrep -u $UID ibus-daemon >/dev/null
		then
			echo "Restarting ibus-daemon in synchronous mode" >&2
			#IBUS_ENABLE_SYNC_MODE=1 ibus-daemon -xrd
			# Apparently an alternative is to run it without --xim:
			IBUS_ENABLE_SYNC_MODE=0 ibus-daemon --replace --verbose -d
			# Neither of the above worked for me! :P
		else
			echo "I cannot restart ibus-daemon because Ubuntu hasn't started it yet!" >&2
		fi

		sleep 1

		# I was doing this earlier, but it was getting reset by something!  (Not us running ibus-daemon, but perhaps Ubuntu running it?)
		# On Ubuntu 14.04 (upgraded from 12.04), /etc/default/keyboard is not being respected by X, so we force it here:
		. /etc/default/keyboard
		#[ -z "$XKBLAYOUT" ] && XKBLAYOUT=gb
		[ -n "$XKBLAYOUT" ] && setxkbmap "$XKBLAYOUT"

	) &

	# Later I will probably start gnome-settings-daemon, otherwise Chrome's font size will be awful.
	# But that will take over screen locking, and will mess up my keyboard repeat speed when unlocking.
	# I tried to workaround that using this:
	#run_after_screen_unlock "sh $HOME/.joeys_x_essentials" &
	# It works, but only after Gnome interface is used to unlock.
	# But I discovered my settings are lost more often that - whenever the machine resumes from suspend.
	# So I started using this instead: /etc/pm/sleep.d/50_restore_joeys_x_settings

	sleep 2

	xscreensaver -no-splash &

) &

# And last but not least we start fluxbox.
# Because it is the last app you have to run it with ''exec'' before it.

# The git version has some bugfixes, and some new bugs!
# Keeping a log is optional
if [ -e /usr/local/fluxbox.git/bin/fluxbox ]
then
	exec /usr/local/fluxbox.git/bin/fluxbox -log "$HOME/.fluxbox/log.txt"
else
	exec fluxbox
fi
# j/jsh fluxbox

